@page "/LeaderboardsDuongLNTs/LeaderboardsDuongLNTList"
@inject GraphQLConsumer _graphQLConsumer
@inject IJSRuntime JS

@using SmokeQuit.GraphQLClients.BlazorWAS.DuongLNT.Models
@using SmokeQuit.GraphQLClients.BlazorWAS.DuongLNT.GraphQLClients

<div class="container mt-4">
    <h3 class="mb-3">Danh sách Leaderboards</h3>

    <a href="/LeaderboardsDuongLNTs/LeaderboardsDuongLNTForm" class="btn btn-info mb-3">+ Tạo mới</a>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (leaderboardsDuongLNTs == null)
    {
        <div>Đang tải dữ liệu...</div>
    }
    else
    {
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th class="text-center">ID</th>
                    <th class="text-center">Ngày không hút</th>
                    <th class="text-center">Tiết kiệm</th>
                    <th class="text-center">Thứ hạng</th>
                    <th class="text-center">Thành tựu</th>
                    <th>Ghi chú</th>
                    <th class="text-center">Top?</th>
                    <th>Thời gian tạo</th>
                    <th>Plan ID</th>
                    <th>User ID</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var leaderboards in leaderboardsDuongLNTs)
                {
                    <tr>
                        <td class="text-center">@leaderboards.LeaderboardsDuongLntid</td>
                        <td class="text-center">@leaderboards.DaySmokeFree</td>
                        <td class="text-center">@leaderboards.MoneySave</td>
                        <td class="text-center">@leaderboards.RankPosition</td>
                        <td class="text-center">@leaderboards.TotalAchievements</td>
                        <td>@leaderboards.Note</td>
                        <td class="text-center">@leaderboards.IsTopRanked</td>
                        <td>@leaderboards.CreatedTime</td>
                        <td>@(leaderboards.Plan?.QuitPlansAnhDtnid.ToString() ?? "N/A")</td>
                        <td>@(leaderboards.User?.UserAccountId.ToString() ?? "N/A")</td>
                        <td class="text-center">
                            <a class="btn btn-sm btn-warning me-1" href="/LeaderboardsDuongLNTs/LeaderboardsDuongLNTForm/@leaderboards.LeaderboardsDuongLntid">
                                Sửa
                            </a>

                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteLeaderboardAsync(leaderboards.LeaderboardsDuongLntid.Value)">
                                Xóa
                            </button>

                            <a class="btn btn-sm btn-primary me-1" href="/LeaderboardsDuongLNTs/LeaderboardsDuongLNTDetail/@leaderboards.LeaderboardsDuongLntid">
                                Xem
                            </a>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<LeaderboardsDuongLnt> leaderboardsDuongLNTs;
    private string errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(500); // Mô phỏng thời gian tải

        try
        {
            leaderboardsDuongLNTs = await _graphQLConsumer.GetLeaderboardsDuongLnt();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task DeleteLeaderboardAsync(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc chắn muốn xóa ID {id}?");
        if (!confirmed) return;

        var success = await _graphQLConsumer.DeleteLeaderboardsDuongLnt(id);
        if (success)
        {
            leaderboardsDuongLNTs = leaderboardsDuongLNTs
                .Where(x => x.LeaderboardsDuongLntid != id)
                .ToList();
        }
        else
        {
            errorMessage = $"Lỗi khi xóa ID {id}";
        }
    }
}
